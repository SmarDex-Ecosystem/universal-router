// SPDX-License-Identifier: UNLICENSED
pragma solidity 0.8.26;

import { IERC20 } from "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import { LibBytes } from "solady-0.1/src/utils/LibBytes.sol";

import { WETH } from "./utils/Constants.sol";
import { UniversalRouterBaseFixture } from "./utils/Fixtures.sol";

import { Commands } from "../../src/libraries/Commands.sol";
import { Enso } from "../../src/modules/Enso.sol";

/**
 * @custom:feature Test the `ENSO` command
 * @custom:background An initiated universal router
 */
contract TestForkEnso is UniversalRouterBaseFixture {
    uint256 internal constant SWAP_AMOUNT = 1 ether;

    function setUp() external {
        SetUpParams memory params = DEFAULT_PARAMS;
        params.forkBlock = 23_790_517;
        _setUp(params);

        deal(address(wstETH), address(this), SWAP_AMOUNT);
    }

    /**
     * @notice Test the token swaps via Enso router
     * @custom:given Some data to send to Enso created via their API
     * @custom:when The `execute` function is called for `ENSO` command
     * @custom:then The `ENSO` command should swap the tokens
     */
    function test_forkEnsoSwapToken() external {
        wstETH.transfer(address(router), SWAP_AMOUNT);
        uint256 balanceWethBefore = IERC20(WETH).balanceOf(address(router));
        // path to swap wstETH to WETH
        bytes memory SWAP_DATA_1 =
            hex"b94c3609000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000400000000000000000000000007f39c581f595b53c5cb19bd0b3f8da6c935e2ca00000000000000000000000000000000000000000000000000de0b6b3a7640000000000000000000000000000000000000000000000000000000000000000090495352c9fad7c5bef027816a800da1736444fb58a807ef4c9603b7848673f7e3a68eb14a52b18b54dc360a293dcb846e18f523383d159e66f8bbd5ecc46961ccd6f5018f4000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000009095ea7b3010001ffffffffff7f39c581f595b53c5cb19bd0b3f8da6c935e2ca0de0e9a3e0101ffffffffff017f39c581f595b53c5cb19bd0b3f8da6c935e2ca0095ea7b3010201ffffffffffae7ab96520de3a18e5e111b5eaab095312d7fe84346387bf4100000000000001bedfac7488dccaafdd66d1d7d56349780fe0477e0303040501060708898affffffffffffffffffffffffffffffffffffffffffffd0e30db00301ffffffffffffc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2a9059cbb010b01ffffffffffc02aaa39b223fe8d0a0e5c4f27ead9083c756cc26e7a43a301010cffffffff017e7d64d987cab6eed08a191c4c2459daf2f8ed0b241c59120101ffffffffffff7e7d64d987cab6eed08a191c4c2459daf2f8ed0b000000000000000000000000000000000000000000000000000000000000000d00000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000000000000000002e00000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000036000000000000000000000000000000000000000000000000000000000000003a000000000000000000000000000000000000000000000000000000000000003e0000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000006a000000000000000000000000000000000000000000000000000000000000006e000000000000000000000000000000000000000000000000000000000000000200000000000000000000000007f39c581f595b53c5cb19bd0b3f8da6c935e2ca000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000de0b6b3a76400000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000bedfac7488dccaafdd66d1d7d56349780fe0477e0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000cf5540fffcdc3d510b18bfca6d2b9987b07725590000000000000000000000000000000000000000000000000000000000000020000000000000000000000000ae7ab96520de3a18e5e111b5eaab095312d7fe840000000000000000000000000000000000000000000000000000000000000020000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000010e8b09a262d149100000000000000000000000000000000000000000000000000000000000000200000000000000000000000004fe93ebc4ce6ae4f81601cc7ce7139023919e0030000000000000000000000000000000000000000000000000000000000000020000000000000000000000000ab27db9e0105af3d9717b0ccef11e2cc65515609000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002043b635ce4000000000000000000000000ae7ab96520de3a18e5e111b5eaab095312d7fe8400000000000000000000000000000000000000000000000010eb22053fadd33a000000000000000000000000365084b05fa7d5028346bd21d842ed0601bab5b8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010e8c2c7fbbbc3000000000000000000000000000000000000000000000000000f37e280c8f5c900000000000000000000000000bedfac7488dccaafdd66d1d7d56349780fe0477e0000000000000000000000000000000000000000000000000000000000000140000000000000000000000000365084b05fa7d5028346bd21d842ed0601bab5b800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000084010206004c0101026800000102030405000601000201ff000000000000000000c4ce391d82d164c166df9c8336ddf84206b2f8127f39c581f595b53c5cb19bd0b3f8da6c935e2ca0c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2775f661b0bd1739349b9a2a3ef60be277c5d2d290fe906e030a44ef24ca8c7dc7b7c53a6c4f00ce900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000";
        bytes memory SWAP_DATA_2 =
            hex"000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000010bd6727f7b6de9900000000000000000000000000000000000000000000000000000000";

        // add the router address to the swap data
        bytes memory SWAP_DATA = bytes.concat(SWAP_DATA_1, bytes20(uint160(address(router))));
        SWAP_DATA = bytes.concat(SWAP_DATA, SWAP_DATA_2);

        bytes memory commands = abi.encodePacked(uint8(Commands.ENSO));
        bytes[] memory inputs = new bytes[](1);

        inputs[0] = abi.encode(address(wstETH), 0, SWAP_DATA);

        router.execute(commands, inputs);

        assertEq(wstETH.balanceOf(address(router)), 0, "wstETH balance should be zero");
        assertGt(
            IERC20(WETH).balanceOf(address(router)), balanceWethBefore, "WETH balance should be greater than before"
        );
    }

    /**
     * @notice Test the ETH swaps via Enso router
     * @custom:given A data to send to Enso create via their API
     * @custom:when The `execute` function is called for `ENSO` command
     * @custom:then The `ENSO` command should swap the ether
     */
    function test_forkEnsoSwapEth() external {
        uint256 routerWstethBalanceBefore = wstETH.balanceOf(address(router));
        uint256 thisEthBalanceBefore = address(this).balance;
        // path to swap ETH to wstETH
        bytes memory SWAP_DATA_1 =
            hex"b94c3609000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000de0b6b3a7640000000000000000000000000000000000000000000000000000000000000000072495352c9fad7c5bef027816a800da1736444fb58a807ef4c9603b7848673f7e3a68eb14a56472712c43041694bfbcd8840182a3ac9a1c29186d93644b428eb45b80de77d8000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000004346387bf4300000000000008bedfac7488dccaafdd66d1d7d56349780fe0477e0001010203000405068788ffffffffffffffffffffffffffffffffffffffffff6e7a43a3010809ffffffff087e7d64d987cab6eed08a191c4c2459daf2f8ed0b241c59120108ffffffffffff7e7d64d987cab6eed08a191c4c2459daf2f8ed0b000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000028000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000056000000000000000000000000000000000000000000000000000000000000005a000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000de0b6b3a76400000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000cf5540fffcdc3d510b18bfca6d2b9987b07725590000000000000000000000000000000000000000000000000000000000000020000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000200000000000000000000000007f39c581f595b53c5cb19bd0b3f8da6c935e2ca000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000b63bc8afd72d3800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000";
        bytes memory SWAP_DATA_2 =
            hex"0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000ab27db9e0105af3d9717b0ccef11e2cc65515609000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002043b635ce400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000de0b6b3a7640000000000000000000000000000365084b05fa7d5028346bd21d842ed0601bab5b80000000000000000000000007f39c581f595b53c5cb19bd0b3f8da6c935e2ca00000000000000000000000000000000000000000000000000b63bc8afd72d3800000000000000000000000000000000000000000000000000b469441eb8dd680000000000000000000000000bedfac7488dccaafdd66d1d7d56349780fe0477e0000000000000000000000000000000000000000000000000000000000000140000000000000000000000000365084b05fa7d5028346bd21d842ed0601bab5b80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008401020600060101026800010102030405ff000000000000000000000000000000c4ce391d82d164c166df9c8336ddf84206b2f812c02aaa39b223fe8d0a0e5c4f27ead9083c756cc27f39c581f595b53c5cb19bd0b3f8da6c935e2ca00fe906e030a44ef24ca8c7dc7b7c53a6c4f00ce9775f661b0bd1739349b9a2a3ef60be277c5d2d2900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000b469441eb8dd68100000000000000000000000000000000000000000000000000000000";

        // add the router address to the swap data
        bytes memory SWAP_DATA = bytes.concat(SWAP_DATA_1, bytes20(uint160(address(router))));
        SWAP_DATA = bytes.concat(SWAP_DATA, SWAP_DATA_2);

        bytes memory commands = abi.encodePacked(uint8(Commands.ENSO));
        bytes[] memory inputs = new bytes[](1);

        inputs[0] = abi.encode(address(0), SWAP_AMOUNT, SWAP_DATA);

        router.execute{ value: SWAP_AMOUNT }(commands, inputs);

        assertEq(address(router).balance, 0, "ETH balance should be zero");
        assertGt(
            wstETH.balanceOf(address(router)), routerWstethBalanceBefore, "wstETH balance should be greater than before"
        );
        assertEq(address(this).balance, thisEthBalanceBefore - SWAP_AMOUNT, "ETH balance should be SWAP_AMOUNT less");
    }

    /**
     * @notice Test the swap via Enso router
     * @custom:given A data with the swap function selector and random data
     * @custom:when The `execute` function is called for `ENSO` command
     * @custom:then The `ENSO` command should revert with the error `EnsoSwapFailed`
     */
    function test_Fork_RevertWhen_SwapFails() external {
        // function selector of the swap function of the Enso router with random data
        bytes memory data = hex"b94c3609236423";
        bytes memory commands = abi.encodePacked(uint8(Commands.ENSO));
        bytes[] memory inputs = new bytes[](1);
        inputs[0] = abi.encode(0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0, 0, data);

        vm.expectRevert(Enso.EnsoSwapFailed.selector);
        router.execute(commands, inputs);
    }
}

